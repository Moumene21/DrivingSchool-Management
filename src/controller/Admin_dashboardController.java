package controller;import java.net.URL;import java.sql.Connection;import java.sql.PreparedStatement;import java.sql.SQLException;import java.util.Optional;import java.util.ResourceBundle;import java.sql.Connection;import java.sql.DriverManager;import java.sql.Statement;import java.sql.ResultSet;import java.sql.SQLException;import javafx.scene.control.Alert;import javafx.scene.control.Alert.AlertType;import model.database;import java.util.ArrayList;import java.util.HashSet;import java.util.List;import java.util.Set;import javafx.collections.FXCollections;import javafx.collections.ObservableList;import javafx.event.ActionEvent;import javafx.fxml.FXML;import javafx.fxml.FXMLLoader;import javafx.fxml.Initializable;import javafx.scene.Parent;import javafx.scene.Scene;import javafx.scene.control.Alert;import javafx.scene.control.Button;import javafx.scene.control.ButtonType;import javafx.scene.control.TableColumn;import javafx.scene.control.TableView;import javafx.scene.control.TextField;import javafx.scene.control.cell.PropertyValueFactory;import javafx.scene.layout.AnchorPane;import javafx.stage.Stage;import javafx.stage.StageStyle;import model.Moniteur;import model.Secretaire;import model.Vehicule;import javafx.event.ActionEvent; // Pour gérer les événements d'action (comme un clic sur un bouton)import javafx.fxml.FXML; // Annotation pour les contrôles définis dans un fichier FXMLimport javafx.scene.control.Alert; // Pour afficher des alertesimport javafx.scene.control.Button; // Pour gérer les boutonsimport javafx.scene.control.TableView; // Pour la gestion des tablesimport javafx.scene.control.TableColumn; // Pour les colonnes des tablesimport javafx.scene.control.cell.PropertyValueFactory; // Pour lier les données aux colonnesimport javafx.scene.control.SelectionModel; // Pour gérer la sélection dans un TableView ou ListViewpublic class Admin_dashboardController implements Initializable {    private double x, y;    // Formulaires    @FXML    private AnchorPane main_form;    @FXML    private AnchorPane moniteur_form;    @FXML    private AnchorPane Secretaire_form;    @FXML    private AnchorPane vehicule_form;    @FXML    private AnchorPane suivi_form;    // Boutons de navigation    @FXML    private Button moniteur_btn;    @FXML    private Button Secretaire_btn;    @FXML    private Button vehicule_btn;    @FXML    private Button Suivi_Paiements_btn;    // Gestion des secrétaires    @FXML    private TableView<Secretaire> Secretaire_table_view;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_id;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_nom;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_prenom;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_com_utilisateur;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_mot_de_passe;    @FXML    private TableColumn<Secretaire, String> Secretaire_col_role;    @FXML    private TextField Secretaire_nom, Secretaire_nom_utilisateur, Secretaire_prenom, Secretaire_mot_de_passe, Secretaire_role;    @FXML    private Button Secretaire_ajouter, Secretaire_modifier, Secretaire_supprimer;    // Gestion des moniteurs    @FXML    private TableView<Moniteur> moniteur_tableview;    @FXML    private TableColumn<Moniteur, String> moniteur_col_id;    @FXML    private TableColumn<Moniteur, String> moniteur_col_nom;    @FXML    private TableColumn<Moniteur, String> moniteur_col_prenom;    @FXML    private TableColumn<Moniteur, String> moniteur_col_nom_utilisateur;    @FXML    private TableColumn<Moniteur, String> moniteur_col_mot_de_passe;    @FXML    private TableColumn<Moniteur, String> moniteur_col_role;    @FXML    private TextField moniteur_id, moniteur_nom, moniteur_prenom, moniteur_nom_utilisateur, moniteur_mot_De_passe, moniteur_role;    @FXML    private Button ajouterMoniteur, moniteur_modifier, moniteur_supprimer;    // Gestion des véhicules    @FXML    private TableView<Vehicule> vehicule_table_view;    @FXML    private TableColumn<Vehicule, String> vehicule_col_id;    @FXML    private TableColumn<Vehicule, String> vehicule_col_marque;    @FXML    private TableColumn<Vehicule, String> vehicule_col_type;    @FXML    private TextField vehicule_id, vehicule_marque, vehicule_type;    @FXML    private Button vehicule_ajouter, vehicule_modifier, vehicule_supprimer;    // Boutons généraux    @FXML    private Button logout, close, minimize;    // ObservableLists pour les tableaux    private ObservableList<Moniteur> listeMoniteurs = FXCollections.observableArrayList();    private ObservableList<Secretaire> listeSecretaires = FXCollections.observableArrayList();    private ObservableList<Vehicule> listeVehicules = FXCollections.observableArrayList();    @FXML    void close(ActionEvent event) {        // Fermer la fenêtre actuelle        Stage stage = (Stage) main_form.getScene().getWindow();        stage.close();    }    @FXML    void minimize(ActionEvent event) {        // Réduire la fenêtre actuelle        Stage stage = (Stage) main_form.getScene().getWindow();        stage.setIconified(true);    }    @FXML    private void switchForm(ActionEvent event) {        if (event.getSource() == moniteur_btn) {            moniteur_form.setVisible(true);            Secretaire_form.setVisible(false);            vehicule_form.setVisible(false);            suivi_form.setVisible(false);        } else if (event.getSource() == Secretaire_btn) {            moniteur_form.setVisible(false);            Secretaire_form.setVisible(true);            vehicule_form.setVisible(false);            suivi_form.setVisible(false);        } else if (event.getSource() == vehicule_btn) {            moniteur_form.setVisible(false);            Secretaire_form.setVisible(false);            vehicule_form.setVisible(true);            suivi_form.setVisible(false);        } else if (event.getSource() == Suivi_Paiements_btn) {            moniteur_form.setVisible(false);            Secretaire_form.setVisible(false);            vehicule_form.setVisible(false);            suivi_form.setVisible(true);        }    }    @FXML     private int getNextAvailableIdByRole(Connection conn, String role) throws SQLException {    // Requête pour récupérer tous les IDs dans la table `personnes`    String allIdsQuery = "SELECT id FROM utilisateurs";    // Requête pour récupérer les IDs liés à la table `seancesformation`    String linkedIdsQuery = "SELECT DISTINCT moniteur_id FROM seancesformation";    // Stocker les IDs existants et liés    Set<Integer> existingIds = new HashSet<>();    Set<Integer> linkedIds = new HashSet<>();    // Charger tous les IDs existants dans `personnes`    try (PreparedStatement stmt = conn.prepareStatement(allIdsQuery);         ResultSet rs = stmt.executeQuery()) {        while (rs.next()) {            existingIds.add(rs.getInt("id"));        }    }    // Charger les IDs liés à `seancesformation`    try (PreparedStatement stmt = conn.prepareStatement(linkedIdsQuery);         ResultSet rs = stmt.executeQuery()) {        while (rs.next()) {            linkedIds.add(rs.getInt("moniteur_id"));        }    }    // Rechercher le premier ID libre qui n'est ni dans existingIds ni dans linkedIds    int id = 1;    while (existingIds.contains(id) || linkedIds.contains(id)) {        id++;    }    return id; // Retourner le premier ID disponible} @FXMLpublic void ajouterMoniteur(ActionEvent event) {    if (!validerChamps(moniteur_nom, moniteur_prenom, moniteur_nom_utilisateur, moniteur_mot_De_passe)) {        return;    }    String insertSQL = "INSERT INTO utilisateurs (id, nom, prenom, nom_utilisateur, mot_de_passe, role) VALUES (?, ?, ?, ?, ?, 'Moniteur')";    try (Connection conn = database.connectDb();         PreparedStatement insertStmt = conn.prepareStatement(insertSQL)) {        // Obtenir le prochain ID disponible        int nextId = getNextAvailableIdByRole(conn, "Moniteur");        insertStmt.setInt(1, nextId);        insertStmt.setString(2, moniteur_nom.getText());        insertStmt.setString(3, moniteur_prenom.getText());        insertStmt.setString(4, moniteur_nom_utilisateur.getText());        insertStmt.setString(5, moniteur_mot_De_passe.getText());        insertStmt.executeUpdate();        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le moniteur a été ajouté avec succès.");        chargerMoniteurs();    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de l'ajout du moniteur : " + e.getMessage());    }}   @FXML private void supprimerMoniteur() {    Moniteur moniteurSelectionne = moniteur_tableview.getSelectionModel().getSelectedItem();    if (moniteurSelectionne == null) {        afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un moniteur avant de continuer.");        return;    }    try (Connection conn = database.connectDb();         PreparedStatement pst = conn.prepareStatement("DELETE FROM utilisateurs WHERE id = ?")) {        // Supprimer uniquement dans la table personnes        pst.setInt(1, moniteurSelectionne.getId());        pst.executeUpdate();        // Recharger les données pour refléter les changements        chargerMoniteurs();        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le moniteur a été supprimé avec succès.");    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la suppression du moniteur : " + e.getMessage());    }}    @FXML    public void modifierMoniteur(ActionEvent event) {        Moniteur moniteurSelectionne = moniteur_tableview.getSelectionModel().getSelectedItem();        if (moniteurSelectionne == null) {            afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un moniteur à modifier.");            return;        }        if (!validerChamps(moniteur_nom, moniteur_prenom, moniteur_nom_utilisateur, moniteur_mot_De_passe)) {            return;        }        try (Connection conn = database.connectDb()) {            String query = "UPDATE utilisateurs SET nom = ?, prenom = ?, nom_utilisateur = ?, mot_de_passe = ? WHERE id = ?";            PreparedStatement pst = conn.prepareStatement(query);            pst.setString(1, moniteur_nom.getText());            pst.setString(2, moniteur_prenom.getText());            pst.setString(3, moniteur_nom_utilisateur.getText());            pst.setString(4, moniteur_mot_De_passe.getText());            pst.setInt(5, moniteurSelectionne.getId());            pst.executeUpdate();            chargerMoniteurs();            afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le moniteur a été modifié avec succès.");        } catch (SQLException e) {            afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la modification : " + e.getMessage());        }    }   private void chargerMoniteurs() {    listeMoniteurs.clear();    try (Connection conn = database.connectDb()) {        String query = "SELECT * FROM utilisateurs WHERE role = 'Moniteur' ORDER BY id ASC";        PreparedStatement pst = conn.prepareStatement(query);        ResultSet resultSet = pst.executeQuery();        while (resultSet.next()) {            Moniteur moniteur = new Moniteur(                    resultSet.getInt("id"),                    resultSet.getString("nom"),                    resultSet.getString("prenom"),                    resultSet.getString("nom_utilisateur"),                    resultSet.getString("mot_de_passe")            );            listeMoniteurs.add(moniteur);        }    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors du chargement des moniteurs : " + e.getMessage());    }    moniteur_tableview.setItems(listeMoniteurs);}   @FXMLpublic void ajouterSecretaire(ActionEvent event) {    if (!validerChamps(Secretaire_nom, Secretaire_prenom, Secretaire_nom_utilisateur, Secretaire_mot_de_passe)) {        return;    }    String insertSQL = "INSERT INTO utilisateurs (id, nom, prenom, nom_utilisateur, mot_de_passe, role) VALUES (?, ?, ?, ?, ?, 'Secretaire')";    try (Connection conn = database.connectDb();         PreparedStatement insertStmt = conn.prepareStatement(insertSQL)) {        int nextId = getNextAvailableIdByRole(conn, "Secretaire");        insertStmt.setInt(1, nextId);        insertStmt.setString(2, Secretaire_nom.getText());        insertStmt.setString(3, Secretaire_prenom.getText());        insertStmt.setString(4, Secretaire_nom_utilisateur.getText());        insertStmt.setString(5, Secretaire_mot_de_passe.getText());        insertStmt.executeUpdate();        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le secrétaire a été ajouté avec succès.");        reinitialiserChampsSecretaire(); // Vider les champs après ajout        chargerSecretaires();    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de l'ajout du secrétaire : " + e.getMessage());    }}private void reinitialiserChampsSecretaire() {    Secretaire_nom.clear();    Secretaire_prenom.clear();    Secretaire_nom_utilisateur.clear();    Secretaire_mot_de_passe.clear();}@FXMLpublic void supprimerSecretaire(ActionEvent event) {    Secretaire secretaireSelectionne = Secretaire_table_view.getSelectionModel().getSelectedItem();    if (secretaireSelectionne == null) {        afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un secrétaire avant de continuer.");        return;    }    try (Connection conn = database.connectDb();         PreparedStatement pst = conn.prepareStatement("DELETE FROM utilisateurs WHERE id = ?")) {        pst.setInt(1, secretaireSelectionne.getId());        pst.executeUpdate();        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le secrétaire a été supprimé avec succès.");        chargerSecretaires();    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la suppression du secrétaire : " + e.getMessage());    }}@FXMLpublic void modifierSecretaire(ActionEvent event) {    Secretaire secretaireSelectionne = Secretaire_table_view.getSelectionModel().getSelectedItem();    if (secretaireSelectionne == null) {        afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un secrétaire à modifier.");        return;    }    if (!validerChamps(Secretaire_nom, Secretaire_prenom, Secretaire_nom_utilisateur, Secretaire_mot_de_passe)) {        return;    }    try (Connection conn = database.connectDb()) {        String query = "UPDATE utilisateurs SET nom = ?, prenom = ?, nom_utilisateur = ?, mot_de_passe = ? WHERE id = ?";        PreparedStatement pst = conn.prepareStatement(query);        pst.setString(1, Secretaire_nom.getText());        pst.setString(2, Secretaire_prenom.getText());        pst.setString(3, Secretaire_nom_utilisateur.getText());        pst.setString(4, Secretaire_mot_de_passe.getText());        pst.setInt(5, secretaireSelectionne.getId());        pst.executeUpdate();        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le secrétaire a été modifié avec succès.");        chargerSecretaires();    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la modification : " + e.getMessage());    }}private void chargerSecretaires() {    listeSecretaires.clear();    try (Connection conn = database.connectDb()) {        String query = "SELECT * FROM utilisateurs WHERE role = 'Secretaire' ORDER BY id ASC";        PreparedStatement pst = conn.prepareStatement(query);        ResultSet resultSet = pst.executeQuery();        while (resultSet.next()) {            Secretaire secretaire = new Secretaire(                resultSet.getInt("id"),                resultSet.getString("nom"),                resultSet.getString("prenom"),                resultSet.getString("nom_utilisateur"),                resultSet.getString("mot_de_passe")            );            listeSecretaires.add(secretaire);        }    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors du chargement des secrétaires : " + e.getMessage());    }    Secretaire_table_view.setItems(listeSecretaires);}@FXMLpublic void ajouterVehicule(ActionEvent event) {    if (!validerChamps(vehicule_marque, vehicule_type)) {        return; // Arrêter si les champs ne sont pas valides    }    String insertSQL = "INSERT INTO vehicules (marque, type) VALUES (?, ?)";    try (Connection conn = database.connectDb();         PreparedStatement insertStmt = conn.prepareStatement(insertSQL)) {        // Ajouter les valeurs des champs        insertStmt.setString(1, vehicule_marque.getText());        insertStmt.setString(2, vehicule_type.getText());        insertStmt.executeUpdate(); // Exécuter la requête        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le véhicule a été ajouté avec succès.");        reinitialiserChampsVehicule(); // Réinitialiser les champs après ajout        chargerVehicules(); // Recharger la liste des véhicules    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de l'ajout du véhicule : " + e.getMessage());    }}@FXMLpublic void modifierVehicule(ActionEvent event) {    Vehicule vehiculeSelectionne = vehicule_table_view.getSelectionModel().getSelectedItem();    if (vehiculeSelectionne == null) {        afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un véhicule à modifier.");        return;    }    if (!validerChamps(vehicule_marque, vehicule_type)) {        return; // Arrêter si les champs ne sont pas valides    }    String updateSQL = "UPDATE vehicules SET marque = ?, type = ? WHERE id = ?";    try (Connection conn = database.connectDb();         PreparedStatement pst = conn.prepareStatement(updateSQL)) {        // Ajouter les nouvelles valeurs        pst.setString(1, vehicule_marque.getText());        pst.setString(2, vehicule_type.getText());        pst.setInt(3, vehiculeSelectionne.getId());        pst.executeUpdate(); // Exécuter la mise à jour        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le véhicule a été modifié avec succès.");        chargerVehicules(); // Recharger la liste des véhicules    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la modification du véhicule : " + e.getMessage());    }}@FXMLpublic void supprimerVehicule(ActionEvent event) {    Vehicule vehiculeSelectionne = vehicule_table_view.getSelectionModel().getSelectedItem();    if (vehiculeSelectionne == null) {        afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez sélectionner un véhicule avant de continuer.");        return;    }    String deleteSQL = "DELETE FROM vehicules WHERE id = ?";    try (Connection conn = database.connectDb();         PreparedStatement pst = conn.prepareStatement(deleteSQL)) {        pst.setInt(1, vehiculeSelectionne.getId()); // Définir l'ID du véhicule sélectionné        pst.executeUpdate(); // Exécuter la suppression        afficherMessage(Alert.AlertType.INFORMATION, "Succès", "Le véhicule a été supprimé avec succès.");        chargerVehicules(); // Recharger la liste des véhicules    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors de la suppression du véhicule : " + e.getMessage());    }}private void chargerVehicules() {    listeVehicules.clear(); // Vider la liste existante    String query = "SELECT * FROM vehicules ORDER BY id ASC";    try (Connection conn = database.connectDb();         PreparedStatement pst = conn.prepareStatement(query);         ResultSet resultSet = pst.executeQuery()) {        while (resultSet.next()) {            Vehicule vehicule = new Vehicule(                resultSet.getInt("id"),                resultSet.getString("marque"),                resultSet.getString("type")            );            listeVehicules.add(vehicule); // Ajouter à la liste        }    } catch (SQLException e) {        afficherMessage(Alert.AlertType.ERROR, "Erreur", "Erreur lors du chargement des véhicules : " + e.getMessage());    }    vehicule_table_view.setItems(listeVehicules); // Mettre à jour la vue}private void reinitialiserChampsVehicule() {    vehicule_marque.clear(); // Effacer le champ "marque"    vehicule_type.clear();   // Effacer le champ "type"}    private boolean validerChamps(TextField... champs) {        for (TextField champ : champs) {            if (champ.getText().isEmpty()) {                afficherMessage(Alert.AlertType.WARNING, "Avertissement", "Veuillez remplir tous les champs.");                return false;            }        }        return true;    }    private void afficherMessage(Alert.AlertType type, String titre, String message) {        Alert alert = new Alert(type);        alert.setTitle(titre);        alert.setHeaderText(null);        alert.setContentText(message);        alert.showAndWait();    }    @Override    public void initialize(URL location, ResourceBundle resources) {         configurerColonnes();    moniteur_tableview.setItems(listeMoniteurs);    chargerMoniteurs();       chargerSecretaires();        Secretaire_table_view.setItems(listeSecretaires);        vehicule_table_view.setItems(listeVehicules);        configurerColonnes(); // Configuration des colonnes chargerVehicules();    }    private void configurerColonnes() {        moniteur_col_id.setCellValueFactory(new PropertyValueFactory<>("id"));        moniteur_col_nom.setCellValueFactory(new PropertyValueFactory<>("nom"));        moniteur_col_prenom.setCellValueFactory(new PropertyValueFactory<>("prenom"));        moniteur_col_nom_utilisateur.setCellValueFactory(new PropertyValueFactory<>("nomUtilisateur"));        moniteur_col_mot_de_passe.setCellValueFactory(new PropertyValueFactory<>("motDePasse"));        moniteur_col_role.setCellValueFactory(new PropertyValueFactory<>("role"));        Secretaire_col_id.setCellValueFactory(new PropertyValueFactory<>("id"));        Secretaire_col_nom.setCellValueFactory(new PropertyValueFactory<>("nom"));        Secretaire_col_prenom.setCellValueFactory(new PropertyValueFactory<>("prenom"));        Secretaire_col_com_utilisateur.setCellValueFactory(new PropertyValueFactory<>("nomUtilisateur"));        Secretaire_col_mot_de_passe.setCellValueFactory(new PropertyValueFactory<>("motDePasse"));        Secretaire_col_role.setCellValueFactory(new PropertyValueFactory<>("role"));        vehicule_col_id.setCellValueFactory(new PropertyValueFactory<>("id"));        vehicule_col_marque.setCellValueFactory(new PropertyValueFactory<>("marque"));        vehicule_col_type.setCellValueFactory(new PropertyValueFactory<>("type"));    }    public void logout() {        Alert alert = new Alert(AlertType.CONFIRMATION);        alert.setTitle("Confirmation Message");        alert.setHeaderText(null);        alert.setContentText("Êtes-vous sûr de vouloir vous déconnecter ?");        Optional<ButtonType> option = alert.showAndWait();        try {            if (option.isPresent() && option.get().equals(ButtonType.OK)) {                logout.getScene().getWindow().hide();                Parent root = FXMLLoader.load(getClass().getResource("FXMLDocument.fxml"));                Stage stage = new Stage();                Scene scene = new Scene(root);                root.setOnMousePressed(event -> {                    x = event.getSceneX();                    y = event.getSceneY();                });                root.setOnMouseDragged(event -> {                    stage.setX(event.getScreenX() - x);                    stage.setY(event.getScreenY() - y);                    stage.setOpacity(0.8);                });                root.setOnMouseReleased(event -> stage.setOpacity(1));                stage.initStyle(StageStyle.TRANSPARENT);                stage.setScene(scene);                stage.show();            }        } catch (Exception e) {            e.printStackTrace();        }    }    private int getNextAvailableId(Connection conn, String moniteur) {        throw new UnsupportedOperationException("Not supported yet."); // Generated from nbfs://nbhost/SystemFileSystem/Templates/Classes/Code/GeneratedMethodBody    }}